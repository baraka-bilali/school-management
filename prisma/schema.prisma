generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int       @id @default(autoincrement())
  name              String
  email             String    @unique
  password          String
  role              User_role @default(ELEVE)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  nom               String?
  prenom            String?
  telephone         String?
  fonction          String?
  schoolId          Int?
  dateCreation      DateTime? @default(now())
  temporaryPassword Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdSchools    School[]  @relation("SchoolsCreated")
  student           Student?
  teacher           Teacher?
  school            School?   @relation("SchoolAdmins", fields: [schoolId], references: [id])

  @@index([schoolId])
}

model AcademicYear {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  current     Boolean      @default(false)
  startDate   DateTime?
  endDate     DateTime?
  enrollments Enrollment[]
}

model Class {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  level       String
  createdAt   DateTime     @default(now())
  letter      String
  section     String
  stream      String?
  enrollments Enrollment[]

  @@index([section])
  @@index([level])
  @@index([section, level, letter])
}

model Student {
  id          Int          @id @default(autoincrement())
  userId      Int          @unique
  code        String       @unique
  lastName    String
  middleName  String
  firstName   String
  gender      String
  birthDate   DateTime
  enrollments Enrollment[]
  user        User         @relation(fields: [userId], references: [id])

  @@index([lastName])
  @@index([code])
  @@index([lastName, firstName])
}

model Teacher {
  id         Int       @id @default(autoincrement())
  userId     Int       @unique
  lastName   String
  middleName String
  firstName  String
  gender     String
  birthDate  DateTime
  specialty  String?
  phone      String?
  hiredAt    DateTime? @default(now())
  user       User      @relation(fields: [userId], references: [id])

  @@index([lastName])
  @@index([specialty])
  @@index([lastName, firstName])
}

model Enrollment {
  id         Int              @id @default(autoincrement())
  studentId  Int
  classId    Int
  yearId     Int
  status     EnrollmentStatus @default(ACTIVE)
  exitReason String?
  class      Class            @relation(fields: [classId], references: [id])
  student    Student          @relation(fields: [studentId], references: [id])
  year       AcademicYear     @relation(fields: [yearId], references: [id])

  @@unique([studentId, classId, yearId])
  @@index([classId], map: "Enrollment_classId_fkey")
  @@index([yearId], map: "Enrollment_yearId_fkey")
}

model School {
  id                          Int               @id @default(autoincrement())
  nomEtablissement            String
  typeEtablissement           TypeEtablissement @default(PRIVE)
  niveauEnseignement          String?           @db.LongText
  codeEtablissement           String?           @unique
  anneeCreation               Int?
  slogan                      String?
  logoUrl                     String?
  statutJuridique             String?
  rccm                        String?
  idNat                       String?
  nif                         String?
  agrementMinisteriel         String?
  dateAgrement                DateTime?
  ministereTutelle            String?
  statutsReglements           String?
  responsableLegal            String?
  pieceIdentiteResponsable    String?
  adresse                     String
  ville                       String
  province                    String
  pays                        String            @default("RDC")
  telephone                   String
  email                       String
  siteWeb                     String?
  directeurNom                String
  directeurTelephone          String
  directeurEmail              String?
  secretaireAcademique        String?
  comptable                   String?
  personnelAdministratifTotal Int?
  cycles                      String?
  nombreClasses               Int?
  nombreEleves                Int?
  nombreEnseignants           Int?
  langueEnseignement          String?
  programmes                  String?
  calendrierScolaire          String?           @db.LongText
  joursOuverture              String?
  domaine                     String?
  identifiantInterne          String            @unique @default(uuid())
  etatCompte                  EtatCompte        @default(EN_ATTENTE)
  dateInscription             DateTime          @default(now())
  derniereMiseAJour           DateTime          @updatedAt
  creeParId                   Int?
  modifieParId                Int?
  dateCreation                DateTime          @default(now())
  dateModification            DateTime          @updatedAt
  dateDebutAbonnement         DateTime?
  dateFinAbonnement           DateTime?
  periodeAbonnement           String?
  planAbonnement              String?
  typePaiement                String?
  montantPaye                 Float?
  createdBy                   User?             @relation("SchoolsCreated", fields: [creeParId], references: [id])
  admins                      User[]            @relation("SchoolAdmins")

  @@index([codeEtablissement])
  @@index([email])
  @@index([creeParId], map: "School_creeParId_fkey")
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  message   String           @db.Text
  schoolId  Int?
  userId    Int?
  isRead    Boolean          @default(false)
  daysLeft  Int?
  createdAt DateTime         @default(now())

  @@index([userId, isRead])
  @@index([schoolId, isRead])
  @@index([createdAt])
}

enum User_role {
  ADMIN
  ELEVE
  COMPTABLE
  PROFESSEUR
  DIRECTEUR_DISCIPLINE
  DIRECTEUR_ETUDES
  SUPER_ADMIN
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  DROPPED_OUT
  EXPELLED
}

enum TypeEtablissement {
  PUBLIC
  PRIVE
  SEMI_PRIVE
}

enum EtatCompte {
  ACTIF
  EN_ATTENTE
  SUSPENDU
}

enum NotificationType {
  SUBSCRIPTION_EXPIRING_15_DAYS
  SUBSCRIPTION_EXPIRING_10_DAYS
  SUBSCRIPTION_EXPIRING_5_DAYS
  SUBSCRIPTION_EXPIRING_2_DAYS
  SUBSCRIPTION_EXPIRING_1_DAY
  SUBSCRIPTION_EXPIRED
}
